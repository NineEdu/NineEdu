name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: nineedu-production-rg
  ACR_NAME: nineeduacr
  ENVIRONMENT: production

permissions:
  contents: write
  packages: read
  id-token: write

jobs:
  # First job: Create infrastructure (including ACR)
  create-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      acr_login_server: ${{ steps.terraform-output.outputs.acr_login_server }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Terraform Authentication
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/production
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}

      - name: Terraform Plan (Infrastructure Only)
        working-directory: infrastructure/terraform/environments/production
        run: |
          terraform plan \
            -target=azurerm_resource_group.main \
            -target=module.container_registry \
            -target=module.key_vault \
            -out=tfplan-infra
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}
          TF_VAR_image_tag: placeholder
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          TF_VAR_groq_api_key: ${{ secrets.GROQ_API_KEY }}
          TF_VAR_cloudinary_cloud_name: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          TF_VAR_cloudinary_api_key: ${{ secrets.CLOUDINARY_API_KEY }}
          TF_VAR_cloudinary_api_secret: ${{ secrets.CLOUDINARY_API_SECRET }}
          TF_VAR_firebase_service_account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          TF_VAR_pinata_jwt: ${{ secrets.PINATA_JWT }}
          TF_VAR_next_public_gateway_url: ${{ secrets.NEXT_PUBLIC_GATEWAY_URL }}

      - name: Terraform Apply (Create ACR and Key Vault)
        working-directory: infrastructure/terraform/environments/production
        run: terraform apply -auto-approve tfplan-infra
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}

      - name: Get ACR Login Server
        id: terraform-output
        working-directory: infrastructure/terraform/environments/production
        run: |
          ACR_SERVER=$(terraform output -raw container_registry_login_server)
          echo "acr_login_server=${ACR_SERVER}" >> $GITHUB_OUTPUT

  # Second job: Build and push images (ACR now exists!)
  build-and-push:
    runs-on: ubuntu-latest
    needs: create-infrastructure
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="prod-${SHORT_SHA}-$(date +%s)"
          echo "tags=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build and push backend image
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
            -f src/backend/Dockerfile \
            src/backend
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:latest

      - name: Build and push frontend image
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
            -f src/frontend/Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=https://production-backend.placeholder.azurecontainerapps.io/api \
            --build-arg NEXT_PUBLIC_GATEWAY_URL=${{ secrets.NEXT_PUBLIC_GATEWAY_URL }} \
            --build-arg PINATA_JWT=${{ secrets.PINATA_JWT }} \
            src/frontend
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:latest

  terraform-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: ${{ steps.terraform-output.outputs.frontend_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Terraform Authentication
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/production
        run: terraform init
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}

      - name: Terraform Plan
        working-directory: infrastructure/terraform/environments/production
        run: terraform plan -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}
          TF_VAR_image_tag: ${{ needs.build-and-push.outputs.image_tag }}
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          TF_VAR_groq_api_key: ${{ secrets.GROQ_API_KEY }}
          TF_VAR_cloudinary_cloud_name: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          TF_VAR_cloudinary_api_key: ${{ secrets.CLOUDINARY_API_KEY }}
          TF_VAR_cloudinary_api_secret: ${{ secrets.CLOUDINARY_API_SECRET }}
          TF_VAR_firebase_service_account: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          TF_VAR_pinata_jwt: ${{ secrets.PINATA_JWT }}
          TF_VAR_next_public_gateway_url: ${{ secrets.NEXT_PUBLIC_GATEWAY_URL }}

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/production
        run: terraform apply -auto-approve tfplan
        env:
          ARM_CLIENT_ID: ${{ env.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ env.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ env.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ env.ARM_TENANT_ID }}

      - name: Get Application URLs
        id: terraform-output
        working-directory: infrastructure/terraform/environments/production
        run: |
          FRONTEND_URL=$(terraform output -raw frontend_url)
          BACKEND_URL=$(terraform output -raw backend_url)
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Deployment Complete!"
          echo "Frontend: ${FRONTEND_URL}"
          echo "Backend: ${BACKEND_URL}"

      - name: Create Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build-and-push.outputs.image_tag }}
          release_name: Production Release ${{ needs.build-and-push.outputs.image_tag }}
          body: |
            ðŸŽ“ **Student Tier Production Deployment**

            âœ… Frontend: ${{ steps.terraform-output.outputs.frontend_url }}
            âœ… Backend: ${{ steps.terraform-output.outputs.backend_url }}

            **Cost Optimization**: Apps scale to zero when idle to save credits!
          draft: false
          prerelease: false