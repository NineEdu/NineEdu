name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: nineedu-production-rg
  ACR_NAME: nineeduproductionacr
  ENVIRONMENT: production

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${{ env.ENVIRONMENT }}-${SHORT_SHA}-$(date +%s)"
          echo "tags=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build and push images
        run: |
          # Backend
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/backend:latest \
            -f src/backend/Dockerfile \
            src/backend
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/backend:latest

          # Frontend
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/frontend:latest \
            -f src/frontend/Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=https://production-backend.placeholder.azurecontainerapps.io/api \
            --build-arg NEXT_PUBLIC_GATEWAY_URL=${{ secrets.NEXT_PUBLIC_GATEWAY_URL }} \
            --build-arg PINATA_JWT=${{ secrets.PINATA_JWT }} \
            src/frontend
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/frontend:latest

  terraform-deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: ${{ steps.terraform-output.outputs.frontend_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/production
        run: terraform init

      - name: Terraform Plan
        working-directory: infrastructure/terraform/environments/production
        run: |
          terraform plan \
            -var="image_tag=${{ needs.build-and-push.outputs.image_tag }}" \
            -var="mongo_uri=${{ secrets.MONGO_URI_PRODUCTION }}" \
            -var="jwt_secret=${{ secrets.JWT_SECRET_PRODUCTION }}" \
            -var="gemini_api_key=${{ secrets.GEMINI_API_KEY }}" \
            -var="groq_api_key=${{ secrets.GROQ_API_KEY }}" \
            -var="cloudinary_cloud_name=${{ secrets.CLOUDINARY_CLOUD_NAME }}" \
            -var="cloudinary_api_key=${{ secrets.CLOUDINARY_API_KEY }}" \
            -var="cloudinary_api_secret=${{ secrets.CLOUDINARY_API_SECRET }}" \
            -var="firebase_service_account=${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" \
            -var="pinata_jwt=${{ secrets.PINATA_JWT }}" \
            -var="next_public_gateway_url=${{ secrets.NEXT_PUBLIC_GATEWAY_URL }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/production
        run: terraform apply -auto-approve tfplan

      - name: Get Application URLs
        id: terraform-output
        working-directory: infrastructure/terraform/environments/production
        run: |
          FRONTEND_URL=$(terraform output -raw frontend_url)
          BACKEND_URL=$(terraform output -raw backend_url)
          echo "frontend_url=${FRONTEND_URL}" >> $GITHUB_OUTPUT
          echo "backend_url=${BACKEND_URL}" >> $GITHUB_OUTPUT
          echo "Frontend: ${FRONTEND_URL}"
          echo "Backend: ${BACKEND_URL}"

      - name: Create Release
        if: github.event_name == 'push'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build-and-push.outputs.image_tag }}
          release_name: Production Release ${{ needs.build-and-push.outputs.image_tag }}
          body: |
            Production deployment completed successfully!

            Frontend: ${{ steps.terraform-output.outputs.frontend_url }}
            Backend: ${{ steps.terraform-output.outputs.backend_url }}
          draft: false
          prerelease: false
